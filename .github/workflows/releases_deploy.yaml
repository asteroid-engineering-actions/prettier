name: release-deploy
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  build_push_docker:
    name: Publish Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v3
      - name: Get Action Version
        id: get-metadata
        run: |
          VERSION=$(./dist/ae_prettier_action_linux_amd64 -version)

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          VERSION="${VERSION#[vV]}"

          Mmp="${VERSION%+*}"
          Mmp="${Mmp%-*}"

          IFS=$'.'
          read -r -a Mmp <<< "$Mmp"
          IFS=$'\n\t'

          VERSION_MAJOR="${Mmp[0]}"
          VERSION_MINOR="${Mmp[1]:-x}"
          VERSION_PATCH="${Mmp[2]:-x}"

          VERSION_PRERELEASE="${VERSION#*-}"

          if [[ "$VERSION" == "$VERSION_PRERELEASE" ]];
          then
              VERSION_PRERELEASE=""
          else
              VERSION_PRERELEASE="${VERSION_PRERELEASE%+*}"
          fi

          BUILD_METADATA="${VERSION#*+}"

          if [[ "$BUILD_METADATA" == "$VERSION" ]];
          then
              BUILD_METADATA=""
          fi

          echo "Version Major: $VERSION_MAJOR"
          echo "VERSION_MAJOR=$VERSION_MAJOR" >> $GITHUB_OUTPUT

          echo "Version Minor: $VERSION_MINOR"
          echo "VERSION_MINOR=$VERSION_MINOR" >> $GITHUB_OUTPUT

          echo "Version Patch: $VERSION_PATCH"
          echo "VERSION_PATCH=$VERSION_PATCH" >> $GITHUB_OUTPUT

          echo "Version PreRelease: $VERSION_PRERELEASE"
          echo "VERSION_PRERELEASE=$VERSION_PRERELEASE" >> $GITHUB_OUTPUT

          echo "Build Metadata: $BUILD_METADATA"
          echo "BUILD_METADATA=$BUILD_METADATA" >> $GITHUB_OUTPUT
      - name: Add and Update Git Tags
        id: add-update-tags
        uses: actions/github-script@v6
        env:
          AE_VERSION_MAJOR: '${{ steps.get-metadata.outputs.VERSION_MAJOR }}'
          AE_VERSION_MINOR: '${{ steps.get-metadata.outputs.VERSION_MINOR }}'
          AE_VERSION_PATCH: '${{ steps.get-metadata.outputs.VERSION_PATCH }}'
          AE_VERSION_PRERELEASE: '${{ steps.get-metadata.outputs.VERSION_PRERELEASE }}'
          AE_BUILD_METADATA: '${{ steps.get-metadata.outputs.BUILD_METADATA }}'
        with:
          script: |
            const {
              AE_VERSION_MAJOR: versionMajor,
              AE_VERSION_MINOR: versionMinor,
              AE_VERSION_PATCH: versionPatch,
              AE_VERSION_PRERELEASE: versionPreRelease,
              AE_BUILD_METADATA: buildMetadata,
            } = process.env;

            const rtrn = {};

            rtrn.coreSemVer = `v${versionMajor}.${versionMinor}.${versionPatch}`;
            rtrn.isPreRelease = '' !== versionPreRelease;
            rtrn.hasBuildMetadata = '' !== buildMetadata;
            rtrn.fullVersion = `${versionMajor}.${versionMinor}.${versionPatch}${rtrn.isPreRelease ? '-' : ''}${versionPreRelease}${rtrn.hasBuildMetadata ? '+' : ''}${buildMetadata}`

            console.log(`Build Version: v${rtrn.fullVersion}`);
\
            rtrn.currentRefs = {};

            if (rtrn.isPreRelease) {
              console.log('Is PreRelease, only adding vM.m.p-P tag');
              return JSON.stringify(rtrn);
            }

            console.log('Not PrRelease, adding vM, vM.m, vM.m.p tags');

            rtrn.coreSemVerRef = `tags/${rtrn.coreSemVer}`;
            rtrn.currentRefs.coreSemVer = await getCurrentRef(rtrn.coreSemVerRef);

            console.log('############################################');
            console.log('# Script Result');
            console.log('############################################');

            console.log(JSON.stringify(rtrn, null, 2));

            async function getCurrentRef(ref) {
              for await (const refs of github.paginate.iterator(github.rest.git.listMatchingRefs, {
                ...context.repo,
                ref,
              })) {
                const githubRefs = refs.data.filter((r) => r.ref === rtrn.majorMinorVerRef);

                if (githubRefs.length > 0) {
                  return ref;
                }
              }

              return undefined;
            }
